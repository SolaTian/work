# UTF-8编码的原理

## ASCII码

在英文环境中，使用每一个 ASCII 码占一个字节，一共128个码位，代表了128个字符，其中0-31位为不可打印字符，32-126位为可打印字符。

十进制0的ASCII码为NULL

这个编码环境在英文环境下比较理想，但是在其他的语系中，ASCII码就不行了，就推出了Unicode编码


> Unicode：中文名叫做统一码，对世界上大多数书写系统中表示的文本进行一致的编码、表示和处理，是一种二进制编码规则。

Unicode是一种字符集，定义了字符的编码方式，包括每个字符对应的唯一代码点（code point）。UTF-8是一种编码方式，它规定了如何将Unicode字符集中的字符编码成字节序列。UTF-8是Unicode的一种实现方式。

## GBK

GBK编码是中文编码标准，用于表示中文字符，不能用来表示其他字符。GBK编码是双字节编码，也就是一个汉字占用两个字节。

## UTF-32

UTF-32编码，每个字符用32位4字节来表示，不够的补0。能够表示很多字符，但是如果是英文环境，会造成大量的浪费

## UTF-16

UTF-16编码，每个字符用16位2字节来表示，不够的补0。空间浪费比UTF-32小了很多。

## UTF-8

UTF-8是变长的，根据字符对应的码位大小，可以是1个字节，也可以是2-4个字节。

1. 如果第一个字节的最高位为0，那么表示这个字符占1个字节，由此可以得出，UTF-8编码是完全兼容ASCII码的，因为ASCII码的最高位也为0。英文字符就使用1字节编码。

2. 如果第一个字节的高3位为110，第二个字节的高2位为10，则表示这个字符占2个字节。第一个字节剩下的5位和第二个字节剩下的6位组合在一起，就是实际的码值。
3. 如果第一个字节的高4位为1110，第二个字节的高2位为10，第三个字节的高2位为10，那么表示这个字符占3个字节。剩下的组合在一起，就是实际的码值。中文字符就使用3字节编码
4. 如果第一个字节的高5位是11110，第二，三，四字节的高2位为10。那么表示这个字符占4个字节。剩下的组合在一起，就是实际的码值。

编码规则：

    #1-byte characters have the following format: 0xxxxxxx  			: U+0000 -> U+007F
    #2-byte characters have the following format: 110xxxxx 10xxxxxx		        : U+0080 -> U+07FF
    #3-byte characters have the following format: 1110xxxx 10xxxxxx 10xxxxxx	  : U+0800 -> U+FFFF
    #4-byte characters have the following format: 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx : U+10000 -> U+10FFFF

可以看到1字节编码的表示范围为0x00-0x7F正好包括ASCII码的区间。


GBK编码转UTF-8编码发生错误的可能原因
1. 如果GBK编码中存在损坏的编码或者非法字节序列，转换UTF-8时会遇到问题。
2. 内存不足，如果存储空间不足以容纳转换后UTF-8字符串，转换可能会失败，因为一个UTF-8占3个字节。举个例子可能最后一个GBK字符转换之后，只剩余2字节，存储不了最后一个3字符的UTF-8编码。
