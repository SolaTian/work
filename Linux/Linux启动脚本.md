# 嵌入式系统启动分析

## 1、设备升级（程序烧录）

### 1.1、网页端升级

### 1.2、串口升级

### 1.3、通过某种 demo 升级


## 2、硬件上电与复位

在嵌入式系统上电之后，电源模块会为系统各个组件提供所需的电压和电流。且会产生一个复位信号，该信号会将处理器和其他的硬件组件的状态恢复成为初始状态。CPU 会从一个固定的地址开始执行代码。这个地址通常是由硬件设计决定的。

### 2.1、片上 ROM 的初始化代码执行

上电和复位之后，并不会立刻进入 U-Boot，而是先执行一个固化在 ROM 上的初始代码（汇编，可能会掺杂一些 C ），这段代码由硬件厂家预先编写好。

这段代码的主要作用是：

1. 对 CPU 的一些基本硬件进行检查和初始化，如时钟系统、内存控制器等
2. 设置系统时钟频率，确保 CPU 和其他组件能够在正确的时钟信号下工作
3. 初始化内存控制器
4. 根据复位的引脚电平状态决定从哪个存储设备加载后续的引导代码。常见的引导源包括：
   - 内部 FLASH
   - 外部 SD 卡
   - NAND FLASH 等  

### 2.2、引导加载程序 BL1 加载与执行

确定好引导源之后，片上 ROM 的初始代码会从相应的存储设备中读取第一段加载引导程序（BL1，汇编语言）到内部 SRAM 中，交接棒到 BL1。

BL1 同样很简短，其主要的任务：
1. 进一步初始化硬件，尤其是外部存储控制器，以便能够访问更大容量的外部内存（如 DDR SDRAM）。
2. 对存储设备进行初始化，为后续加载第二阶段引导加载程序（BL2）做好准备。


### 2.3、引导加载程序 BL2 加载与执行

外部内存初始化完成后，BL1 会从存储设备中读取第二阶段引导加载程序（BL2，）到外部内存中，交接到 BL2 手中。

BL2 比 BL1 的体积大，因此需要外部内存来存储和执行。

BL2 的主要任务是进行更全面的硬件初始化，包括：
1. 串口、网卡、USB 等设备的初始化；
2. 对文件系统进行初始化，以便能够从存储设备读取更加复杂的文件；
3. 将 BootLoader 加载到内存中的指定地址。


## 3、BootLoader（启动加载器）

终于到了 BootLoadr，BootLoader 有很多种，以下列出：

|分类|应用领域|
|-|-|
|U-Boot|应用范围包括智能手机、平板电脑、路由器、工业控制设备等|
|RedBoot|常用于一些对成本和资源要求较高的嵌入式设备，如智能家居设备、小型工业控制器等|
|Grub|常用于需要支持多操作系统引导的设备中，如一些工业电脑、车载电脑等|

它们的关系就好比是类和实例的关系。

以下介绍 BootLoader 就以 U-Boot 为例。

BL2 将 U-Boot 镜像从存储设备加载到内存的指定地址。U-Boot 镜像通常包括代码段、数据段和 BSS 段等，加载过程需要确保这些段被正确地放置在内存中。加载完成之后，会跳转到 U-Boot 的入口地址。

U-Boot 的主要任务包括以下：
1. 硬件初始化：包括但不限于设置CPU的运行模式、初始化时钟系统以确保CPU和其他硬件能在合适的频率下工作、配置内存控制器使系统能够正确访问外部内存、初始化中断控制器以处理系统运行过程中的各种中断事件等。
2. 建立内存空间映射：明确不同内存区域的用途，如代码段、数据段、堆栈段的起始地址和大小，帮助操作系统内核和应用程序能够正确访问和管理内存资源。
3. 加载并启动操作系统内核：从存储设备（如 FLASH、SD 卡中）读取操作系统内核镜像文件，并加载到内存中的指定位置。通过设置必要的参数（内核命令行参数）和环境，跳转到内核的入口地址，启动操作系统。
4. 提供用户交互界面：一些 BootLoader 会提供命令行或菜单界面，允许在系统启动中进行一些操作，如修改启动参数、选择不同的启动选项等。U-Boot 为例，用户可以在启动时通过串口或者网络连接到开发板，修改一些环境变量、执行文件传输命令、加载不同的内核镜像等。


## 内核（Kernel）

内核随后接管控制，其主要工作包括以下：

1. 硬件初始化，继续进行更深入的硬件初始化工作，探测系统中的各种硬件设备，如网卡，硬盘，USB 设备等。
2. 内存管理初始化：内核进一步完善内存管理机制，对系统的物理内存进行分页，建立虚拟内存映射，为后续进程运行分配内存空间。同时也会初始化内核自身的数据结构和缓冲区，确保内核能够合理使用内存资源。
3. 进程管理初始化：内核创建第一个用户级进程，即 init 进程（在 Systemd 出现后，通常由 Systemd 替代 init 进程的角色）。这个进程是所有用户进程的祖先，进程ID（PID）为 1。init 进程的启动标志系统从内核空间进入用户空间。


## 启动脚本(initrun.sh)

桌面版的启动脚本`initrun.sh`（或者其他名字）的存放和编写方式由具体的Linux发行版和系统配置。有可能放置在以下位置

    /etc/init.d/
    /etc/rc.local/                      
    /etc/systemd/system/                #对于使用Systemd的系统，启动脚本通道存放在系统的这个目录下
    /etc/init/

而在嵌入式系统，启动脚本可能被放置在一些自定义路径中，在定制化的启动脚本中，就会做如下配置：

- 设置环境变量
- 设置OOM阈值等
- 配置网络接口
- 定制启动各个进程app

