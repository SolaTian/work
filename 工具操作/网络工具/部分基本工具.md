# 网络状况排查

## ping

ping 命令主要用于测试网络连通性，通过发送 ICMP 回声请求包来确定目标主机是否可达。

### ping 小包

    ping <目标 IP 或 域名> -c 次数

-c 可选，不加就会一直 ping ,按下 Ctrl + C 结束命令，可以查看丢包率， 通过这个命令可以判断网络是否可达

### ping 大包

    ping -s <包大小> <目标 IP 或 域名> -c 次数


不加 -s ，就会 ping 默认大小的数据包， 一般默认为 64 bytes

有时虽然目标 IP 可达，但是网络状况不好，存在丢包，就可能会存在数据丢失情况。


## telnet

测试端口连通性

    telnet <目标 IP 或 域名> <端口号>

若端口开放，则建立连接，否则会提示建立连接失败。

telnet 也可以用于远程登录（默认端口23），当远程服务器开启了 telnet 服务，可以使用

    telnet <目标 IP 或 域名>

来远程登录，但是由于安全问题，一般使用 SSH 登录（默认端口22）

# 网络抓包

## tcpdump

除了 WireShark 这一图形化界面抓包软件，在嵌入式 Linux 中，经常会使用 tcpdump 工具进行抓包。命令如下

    tcpdump -i <网卡> -C <文件大小，MB> -W <最多保存文件数量> -w <抓包保存路径及文件名> -v host <主机IP> [and port <端口号>] 

-v 表示数据包输出比默认模式更多的数据包信息，如协议类型，时间戳等。一般情况下，不需要限制抓包的大小，-C 和 -W　可以缺省。

抓出来的包再使用 WireShark 进行分析

# 网络状态

## netstat

netstat 用于展示系统当前的网络连接状态，包括 Internet 连接和 UNIX 域套接字连接

    Proto Recv-Q Send-Q Local Address           Foreign Address         State
    tcp        0     64 10.11.97.166:22         10.11.97.122:61588      ESTABLISHED
    tcp        0      0 10.11.97.166:50620      10.11.97.24:5000        TIME_WAIT

    Proto RefCnt Flags       Type       State         I-Node Path
    unix  2      [ ]         DGRAM                      6149 @/org/kernel/udev/udevd

- Recv-Q：接收队列，指的是在本地接收缓冲区中等待应用程序读取的数据字节数
- Send-Q：发送队列，代表本地发送缓冲区中还未被对方确认的数据字节数
- Local Address：本地地址和端口号
- Foreign Address：远程地址和端口号
- State：连接状态
- RefCnt：引用计数，指的是有多少个进程正在使用这个套接字。例如 2 表示有 2 个进程正在使用该套接字。
- Flags：套接字的标志，这里 [ ] 表示没有特殊标志。
- Type：套接字的类型，DGRAM 表示数据报套接字，通常用于无连接的通信；STREAM 表示流式套接字，用于面向连接的可靠通信。
- State：套接字的状态，对于 DGRAM 类型通常为空，CONNECTED 表示流式套接字已经建立连接。
- Path：套接字文件的路径。对于一些抽象的套接字，路径以 @ 开头；对于普通的文件套接字，显示其在文件系统中的实际路径


    netstat [选项]

- -a：显示所有活动的网络连接
- -p：显示每隔网络连接对应的进程ID和程序名称
- -l：显示监听中的套接字
- -t: 显示TCP连接
- -n：显示UDP连接

还有些其他的选项，可以使用  `netstat -h` 来获取

示例： 

    netstat -tp

会列出系统中所有 TCP 协议的网络连接，并且同时显示每个连接对应的进程 ID 和进程名称


## traceroute 

traceroute 用于跟踪网络数据包从源主机到目标主机所经过的路由路径。

    traceroute [选项] 目标主机

- -m：设置最大跳数，如果无法达到目标主机，traceroute 就会停止输出相应信息，若不指定，则按照默认最大跳数。
- -n: 直接显示IP地址，而不进行反向 DNS 查找将 IP 地址解析成域名，加快显示速度

    #traceroute www.example.com
    traceroute to www.example.com (93.184.216.34), 30 hops max, 60 byte packets
    1  router1.example.net (192.168.1.1)  1.234 ms  1.567 ms  1.890 ms
    2  router2.example.net (10.0.0.1)  2.345 ms  2.678 ms  2.901 ms
    3  123.45.67.89  3.456 ms  3.789 ms  4.012 ms
    ...
    30  * * *                

表示一个跳的信息，包括路由器的域名（如果可以解析）、IP 地址和三次尝试的往返时间（RTT，Round-Trip Time）
符号 * 表示该跳没有收到响应，可能是路由器设置了不响应 ICMP 消息，或者存在网络故障。


# 网络带宽测试

## iperf

iperf 是一个网络性能测试工具，当网络带宽等限制时，有可能会出现数据拥堵等问题，这时就可以用 iperf 工具测试网络带宽，同时也可以测试丢包率、延迟等性能指标。


测试网络带宽时，需要在服务器和客户端同时启用。

测试步骤如下：

1. 服务端操作：

        iperf -s 

2. 客户端操作：

        iperf -c <服务器 IP 地址> 

还有一些可选项

服务器选项：

- -s: 以服务器模式启动，服务器会监听指定端口（默认5001），等待客户端连接并接收数据
- -p：指定服务器监听的端口号
- -u：以 UDP 模式运行服务器。默认情况，iperf 使用 TCP 协议

客户端选项：

- -c：以客户端模式启动 iperf
- -p：指定客户端要连接到服务器的端口号，需与服务器监听的端口一致
- -u：以 UDP 模式运行客户端，与服务器的 UDP 模式对应
- -b：指定客户端发送数据的带宽，单位可以是 K（千比特）、M（兆比特）、G（吉比特）等。例如 -b 10M 表示以 10Mbps 的带宽发送数据，常用于 UDP 测试模拟不同带宽的流量。

测试参数选项：

- -t：指定测试的持续时间，单位为 s。
- -n：指定要传输的数据量，单位可以为 K、M、G 等。例如 -n 1G 表示传输 1GB 的数据，测试会在传输完指定数据量后停止。
- -i：指定统计信息的输出间隔，单位为 s。
- -w：设置套接字缓冲区的大小，合适的缓冲区大小可以提高传输效率，设置过大可能会占用过多的系统内存资源。单位可能是字节或者千字节
- -d：以双工模式运行，服务器不仅接收客户端数据，还会向客户端发送数据，同时测试网络两个方向的性能。


测试效果示例分析

服务端：

    #iperf -s -w 320k -i 1 -d
    ------------------------------------------------------------
    Server listening on TCP port 5001
    TCP window size: 320 KByte (WARNING: requested 320 KByte)
    ------------------------------------------------------------

    [  4] local 192.168.1.100 port 5001 connected with 192.168.1.101 port 49152
    [ ID] Interval       Transfer     Bandwidth
    [  4]  0.0-1.0 sec  110 MBytes   973 Mbits/sec

在 0s - 1s 的时间段内，传输的数据总量是 110M 字节，带宽为 973 Mbit/s, 根据网口的带宽限制，就可以知道是否当前状况下，上行带宽是怎样的。

客户端：

    #iperf -c 192.168.1.100 -w 320k -i 1
    ------------------------------------------------------------
    Client connecting to 192.168.1.100, TCP port 5001
    TCP window size: 320 KByte (WARNING: requested 320 KByte)
    ------------------------------------------------------------
    [  3] local 192.168.1.101 port 49152 connected with 192.168.1.100 port 5001
    [ ID] Interval       Transfer     Bandwidth
    [  3]  0.0- 1.0 sec  110 MBytes   922 Mbits/sec
    [  3]  1.0- 2.0 sec  112 MBytes   940 Mbits/sec

在 0 - 1 sec 表示从测试开始后的 0 秒到 1 秒这 1 秒钟的时间段，传输了 110 兆字节（MB）的数据，带宽为 922 兆比特每秒（Mbits/sec）。

通过这些指标对比客户端和服务端之间的网络传输性能

1. 服务端带宽波动较大或者数值较低，客户端带宽较稳定，服务端数据接收时存在网络拥堵情况。
2. 客户端带宽波动较大或者数值较低，服务端带宽较稳定，服务端数据接收时存在网络拥堵情况。


# 文件系统磁盘使用情况

## df

df 命令可以显示文件系统磁盘空间的使用情况

    df [选项] [文件或挂载点]

- -h：以人类可读格式显示
- -a：显示所有文件系统，包括虚拟文件系统
- -t：显示指定类型的文件系统
- -x：不显示指定类型的文件系统

常用的就是上面两个参数

    #df -h
    Filesystem                Size      Used Available Use% Mounted on
    rootfs                  249.3M     20.0M    229.2M   8% /
    udev                    252.9M    148.0K    252.8M   0% /dev
    /dev/mmcblk0p19         120.0M     62.5M     54.9M  53% /dav0
    /dev/mmcblk0p20         120.0M     62.5M     54.9M  53% /dav1
    /dev/mmcblk0p21          14.5M     12.2M      2.0M  86% /dav2
    /dev/mmcblk0p23          14.5M    143.0K     14.0M   1% /sysLog
    /dev/mmcblk0p26           2.9G    197.5M      2.6G   7% /dav4
    /dev/sda1                19.6G     44.5M     18.5G   0% /mnt/sda

- Filesystem：文件系统的名称，通常是设备文件（如 /dev/sda1）或挂载点对应的设备。
- Size：文件系统的总大小。
- Used：已使用的磁盘空间大小。
- Avail：可用的磁盘空间大小。
- Use%：磁盘空间的使用百分比。
- Mounted on：文件系统的挂载点，即文件系统在目录树中的挂载位置。

根据这些信息，就可以了解各个文件系统的磁盘使用情况，发现磁盘空间不足问题。


# 系统内存占用

## ps

ps 命令用于查看当前系统上运行的进程、线程信息。

    ps [选项]

- a：显示所有用户的进程（包括其他用户的进程）。
- u：显示进程的所有者（即用户名）。
- x：显示没有控制终端的进程（后台进程）。
- e：显示所有进程（包括其他用户的进程）。
- f：显示进程的树状结构，即父进程与子进程之间的关系。
- L：显示线程。
- T：显示进程的线程信息，常常和 -p 一起使用。
- p：显示指定进程ID，只查看特定进程的状态信息。

ps aux 和 ps -ef 的效果一样，只是输出格式不同。


### 显示进程信息
示例

    #ps aux 
    USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
    root         1  0.1  0.2 169128  8908 ?        Ss   12:45   0:03 /sbin/init
    user      1234  0.0  0.1  74832  4608 pts/0    Ss+  12:46   0:00 bash
    user      5678  1.2  0.5 500000 25000 pts/1    Sl+  12:47   1:23 python3 script.py

- PID：进程ID
- TTY：终端类型，指该进程在哪个终端上运行，如果进程是后台进程或没有终端，则显示为 ?。
- TIME：进程使用的 CPU 时间总量。
- CMD：进程启动时的命令行。
- %CPU：进程使用的 CPU 百分比。
- %MEM：进程使用的物理内存百分比。
- STAT：进程/线程状态
  - S：表示休眠
  - R：表示运行中
  - Z：表示僵尸进程
  - T：停止状态
  - D：不可中断的休眠状态
  - Ss：主线程休眠（s 表示会话首进程）
  - Sl：多线程休眠（l 表示多线程）
  - Sl+：多线程休眠且在前台进程组（+ 表示前台）
  - R+：运行中的前台进程
- VSZ：进程使用的虚拟内存大小。
- RSS：进程使用的实际物理内存（驻留集大小）。


        #ps -ef
        UID        PID  PPID  C STIME TTY          TIME CMD
        root         1     0  0 12:45 ?        00:00:03 /sbin/init
        user      1234  5678  0 12:46 pts/0    00:00:00 bash
        user      5678  1234  1 12:47 pts/1    01:23:00 python3 script.py

### 显示线程消息

示例

    #ps -T -p 1234
    PID   SPID TTY      STAT   TIME COMMAND
    1234  1234 pts/1    Sl     0:00 ./my_server
    1234  1235 pts/1    Sl     0:00 ./my_server
    1234  1236 pts/1    Sl     0:00 ./my_server

    #ps -Lf -p 1234
    UID        PID  PPID   LWP  C NLWP STIME TTY      STAT   TIME CMD
    user      1234  1233  1234  0    5 14:30 pts/0    Sl+    1:23 /usr/bin/my_server
    user      1234  1233  1235  0    5 14:30 pts/0    Sl+    0:45 /usr/bin/my_server
    user      1234  1233  1236  0    5 14:30 pts/0    Sl+    0:12 /usr/bin/my_server

该命令会列出指定进程的所有线程，每个线程会显示自己的线程ID（LWP）、状态、CPU使用情况等，下面的命令会更加详细的显示出线程信息。
- PID：进程ID。
- SPID：线程ID。每个线程有独立的 SPID（在 Linux 中等同于 LWP 或 TID）。
- TTY：进程关联的终端。pts/1 表示伪终端（如 SSH 或终端窗口）。
- STAT：进程/线程的状态
- TIME：进程/线程累计使用的 CPU 时间。
- COMMAND：启动进程的命令名称。多线程程序的线程通常显示相同的命令名。



    #ps -eLf
    UID        PID  PPID   LWP  C NLWP STIME TTY      STAT   TIME CMD
    root         1     0     1  0    2 14:30 ?        Ss     0:01 /sbin/init
    root         1     0     2  0    2 14:30 ?        Ss     0:00 /sbin/init
    user      1234  1233  1234  0    5 15:00 pts/0    Sl+    1:23 /usr/bin/myapp
    user      1234  1233  1235  0    5 15:00 pts/0    Sl+    0:45 /usr/bin/myapp
    user      5678  5677  5678  0    1 15:01 ?        S      0:00 /usr/sbin/sshd

该命令会显示所有进程及其线程信息。

- UID：进程所有者的用户 ID（如 root 或用户名）。
- PID：进程ID。同一进程的多个线程共享相同的 PID。
- PPID：父进程的 PID。
- LWP：线程的唯一标识符。主线程的 LWP 通常等于 PID，其他线程的 LWP 为独立值。
- C：CPU 占用率（百分比）。通常为瞬时值，可能与 top 数据略有差异。
- NLWP：进程包含的线程总数。例如，PID 为 1234 的进程有 5 个线程。
- STIME：进程启动时间（格式：小时:分钟）。
- TTY：关联的终端。?：无关联终端（通常是守护进程）。pts/0：伪终端（如 SSH 或终端窗口）。
- STAT：进程/线程状态码。
- TIME：累计使用的 CPU 时间（格式：分:秒）。
- CMD：启动进程的命令名称。线程通常显示与主进程相同的命令名。

## top

top 是一个实施监控工具，用于显示系统资源的使用情况，与 ps 命令不同的地方在于其显示的内容是动态更新的。

输入 top 之后，就会进入交互式的界面

    top

默认显示所有进程的信息。它会实时更新进程信息，默认每 3 秒刷新一次。

示例

    #top
    top - 14:06:23 up 70 days, 16:44,  2 users,  load average: 1.25, 1.32, 1.35
    Tasks: 206 total,   1 running, 205 sleeping,   0 stopped,   0 zombie
    Cpu(s):  5.9%us,  3.4%sy,  0.0%ni, 90.4%id,  0.0%wa,  0.0%hi,  0.2%si,  0.0%st
    Mem:  32949016k total, 14411180k used, 18537836k free,   169884k buffers
    Swap: 32764556k total,        0k used, 32764556k free,  3612636k cached

    PID   USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND                                                                
    28894 root      22   0 1501m 405m  10m S 52.2  1.3   2534:16 java                                                                   
    18249 root      18   0 3201m 1.9g  11m S 35.9  6.0 569:39.41 java                                                                          
    1     root      15   0 10368  684  572 S  0.0  0.0   1:30.85 init                                                                   
    2     root      RT  -5     0    0    0 S  0.0  0.0   0:01.01 migration/0  
    ...

系统摘要区

- 14:06:23 — 当前系统时间
- up 70 days, 16:44 — 系统已经运行了70天16小时44分钟（在这期间系统没有重启）
- 2 users — 当前有2个用户登录系统
- load average: 1.15, 1.42, 1.44 — load average后面的三个数分别是1分钟、5分钟、15分钟的负载情况。如果这个数除以逻辑CPU的数量，结果高于5的时候就表明系统在超负荷运转了。
- Tasks：显示总进程数及状态（运行、休眠、僵尸等）。
- Cpu(s)：
  - 5.9%us — 用户空间占用CPU的百分比。
  - 3.4% sy — 内核空间占用CPU的百分比。
  - 0.0% ni — 改变过优先级的进程占用CPU的百分比
  - 90.4% id — 空闲CPU百分比
  - 0.0% wa — IO等待占用CPU的百分比
  - 0.0% hi — 硬中断（Hardware IRQ）占用CPU的百分比
  - 0.2% si — 软中断（Software Interrupts）占用CPU的百分比
- Mem：内存状态
  - 32949016k total — 物理内存总量（32GB）
  - 14411180k used — 使用中的内存总量（14GB）
  - 18537836k free — 空闲内存总量（18GB）
  - 169884k buffers — 缓存的内存量 （169M）
- Swap：Swap交换分区信息
  - 32764556k total — 交换区总量（32GB）
  - 0k used — 使用的交换区总量（0K）
  - 32764556k free — 空闲交换区总量（32GB）
  - 3612636k cached — 缓冲的交换区总量（3.6GB）

使用中的内存总量（used）指的是现在系统内核控制的内存数，空闲内存总量（free）是内核还未纳入其管控范围的数量。纳入内核管理的内存不见得都在使用中，还包括过去使用过的现在可以被重复利用的内存，内核并不把这些可被重新使用的内存交还到 free 中去，因此在 Linux 上 free 内存会越来越少。

计算可用内存数，这里有个近似的计算公式：第四行的free + 第四行的buffers + 第五行的cached，按这个公式此台服务器的可用内存：18537836k +169884k +3612636k = 22GB左右。

对于内存监控，在 top 里要时刻监控第五行 Swap 交换分区的used，如果这个数值在不断的变化，说明内核在不断进行内存和 Swap 的数据交换，这是真正的内存不够用了。


进程状态监控区

- PID：进程id
- USER：进程所有者
- PR：进程优先级
- NI：nice值。负值表示高优先级，正值表示低优先级
- VIRT：进程使用的虚拟内存总量，单位kb。VIRT=SWAP+RES
- RES：进程使用的、未被换出的物理内存大小，单位kb。RES=CODE+DATA
- SHR：共享内存大小，单位kb
- S：进程状态。D=不可中断的睡眠状态 R=运行 S=睡眠 T=跟踪/停止 Z=僵尸进程
- %CPU：上次更新到现在的CPU时间占用百分比
- %MEM：进程使用的物理内存百分比
- TIME+：进程使用的CPU时间总计，单位1/100秒
- COMMAND：进程名称（命令名/命令行）

top 界面还有一些交互命令。

- P：按照 CPU 使用率进行排序
- M：按照内存使用率进行排序
- k：终止指定 PID 的进程（需输入 PID）
- H：切换进程/线程视图（显示线程时，PID 列变为线程 ID）
- q：退出 top

除了上述交互命令之外，top 还有一些选项

- -p PID：仅监控指定进程（如 top -p 1234）。
- -u USER：仅显示指定用户的进程。
- -H：默认显示线程（等同于交互模式下按 H 键）。
- -b：以批处理模式运行（适合输出到文件）。


## stat_mem




## /proc/meminfo




